# MauNgekos - AI Coding Agent Instructions

## Project Overview

**MauNgekos** is a React Native kos (boarding house) rental marketplace app for Indonesia, built with Expo Router, NativeWind (Tailwind), Firebase/Firestore, and Supabase Storage. Three user roles: `pencari` (searchers), `penyewa` (property owners), and `admin` (approvers).

## Architecture & Key Patterns

### Tech Stack

- **Framework**: Expo SDK 54 with New Architecture enabled
- **Routing**: Expo Router v6 (file-based routing in `app/` directory)
- **Styling**: NativeWind v4 + Tailwind CSS
- **UI**: React Native Reusables (@rn-primitives) - shadcn-style components
- **Auth & Database**: Firebase Auth + Firestore
- **Storage**: Supabase for image uploads
- **State**: Context API (no Redux/Zustand)
- **Maps**: `react-native-maps` with Google Maps API

### Directory Structure

```
app/(auth)/          - Login/register screens (guest access)
app/(pencari)/       - Searcher flow (map, favorites, profile) - accessible to guests
app/(penyewa)/       - Owner flow (dashboard, add/edit kos)
app/(admin)/         - Admin approval queue
contexts/            - AuthContext with Firebase integration
services/            - kosService.ts for Firestore operations
lib/                 - firebase.ts, supabase.ts, theme.ts, utils.ts
components/ui/       - Reusable UI primitives (do NOT manually edit)
types/index.ts       - TypeScript types and constants
```

### Role-Based Routing

- **Root Layout** (`app/_layout.tsx`): Handles auth-based navigation redirects
- **Index** (`app/index.tsx`): Entry point that redirects based on user role
- Guards enforce: pencari → home, penyewa → dashboard, admin → approvals
- **Guest access**: Unauthenticated users can browse `(pencari)` routes (map/search)

### Data Flow & Services

- **AuthContext** provides: `{ user, firebaseUser, loading, signIn, signUp, signOut }`
- **kosService.ts** patterns:
  ```typescript
  getApprovedKos(); // Public listings (status='approved')
  getKosByOwner(uid); // Owner's properties
  getPendingKos(); // Admin approval queue
  createKos(data); // Owner creates (status='pending')
  updateKosStatus(id, status); // Admin approves/rejects
  ```
- **Client-side filtering**: Firestore compound query limitations mean price/facility filters happen client-side
- **Image upload**: Use `uploadImage(uri, path)` from `lib/supabase.ts` → returns public URL

### Type System (`types/index.ts`)

```typescript
UserRole = 'pencari' | 'penyewa' | 'admin';
KosType = 'putra' | 'putri' | 'campur'; // Male/Female/Mixed boarding
KosStatus = 'pending' | 'approved' | 'rejected';
```

- **Facilities**: Split into `ROOM_FACILITIES` (in-room) and `COMMON_FACILITIES` (shared)
- **GeoPoint**: Use Firebase `GeoPoint` type for location storage, not plain lat/lng objects

### Styling & Theming

- **NativeWind**: Use Tailwind utility classes (`className="bg-primary text-white"`)
- **Theme**: Custom teal primary color (`hsl(175 66% 32%)`) defined in `lib/theme.ts`
- **Fonts**: Manrope family (400-800 weights) from `@expo-google-fonts/manrope`
- **Dark Mode**: `useColorScheme()` from `nativewind` for theme detection
- Component variants use `class-variance-authority` (cva)

### UI Component Guidelines

- Import from `@/components/ui/*` (button, input, text, card, etc.)
- **DO NOT** manually edit components in `components/ui/` - generated by React Native Reusables CLI, **EXCEPT** if i asked to.
- To add new components: `npx @react-native-reusables/cli@latest add <component-name>`
- Icons: Use `lucide-react-native` (e.g., `<MapPin size={24} color="..." />`)

## Development Workflows

### Running the App

```bash
npm run dev          # Start Expo dev server
# Then: press 'a' (Android), 'i' (iOS), or 'w' (Web)
npm run clean        # Clear Expo cache and node_modules
```

### Path Aliases

- **`@/`** maps to root directory (configured in `tsconfig.json`)
- Example: `import { useAuth } from '@/contexts/AuthContext'`

### Firebase/Supabase Config

- Credentials are hardcoded in `lib/firebase.ts` and `lib/supabase.ts`
- **TODO comments** indicate where to replace with production values
- AsyncStorage used for auth persistence on native platforms

### Location Handling

- Permissions requested via Expo plugins (see `app.json`)
- Use `expo-location` for getting user coordinates
- Convert to Firebase `GeoPoint` before saving: `createGeoPoint(lat, lng)`

## Common Patterns

### Form Handling in Add/Edit Screens

```typescript
const [loading, setLoading] = useState(false);
const [images, setImages] = useState<string[]>([]);
// Upload images first, then create Kos with URLs
const imageUrls = await Promise.all(
  images.map((uri, i) => uploadImage(uri, `kos/${userId}/${Date.now()}_${i}.jpg`))
);
```

### Authentication Checks

```typescript
const { user, loading } = useAuth();
if (!user) {
  router.replace('/(auth)/login');
  return null;
}
```

### Expo Router Navigation

```typescript
import { router } from 'expo-router';
router.push('/(pencari)/kos/[id]', { id: kosId }); // Navigate with params
router.replace('/(auth)/login'); // Replace (no back)
```

### Tab Navigation

- Defined in `app/(role)/_layout.tsx` using `<Tabs>` from Expo Router
- Icons from lucide-react-native
- Bottom insets handled with `useSafeAreaInsets()`

## Project-Specific Conventions

1. **Firestore Collections**: Always use `serverTimestamp()` for createdAt/updatedAt
2. **Status Flow**: New kos → `pending` → admin reviews → `approved`/`rejected`
3. **Available Rooms**: Must be <= totalRooms (validate client-side)
4. **Image Paths**: Format as `kos/{ownerId}/{timestamp}_{index}.jpg`
5. **Error Handling**: Use `Alert.alert()` for user-facing errors, `console.error` for logs
6. **Loading States**: Show `<ActivityIndicator>` during async operations
7. **Modularization**: Services handle data, screens handle UI/state

## Critical Gotchas

- **Do NOT** use `getAuth()` on native - use `initializeAuth()` with AsyncStorage persistence (see `lib/firebase.ts`)
- **Client-side filters**: Firestore can't handle complex OR queries - fetch approved kos, filter in JS
- **Image picker**: Always check `result.canceled` before accessing `result.assets[0]`
- **TypeScript**: Strict mode enabled - null checks required for optional fields
- **Expo Router**: Use typed routes when available (`href={...}` not string-only)
- Hindari penggunaan komentar dalam kode yang berlebihan; gunakan nama variabel dan fungsi yang jelas untuk meningkatkan keterbacaan kode.

## Testing & Debugging

- No test suite configured yet
- Use Expo DevTools for debugging
- React Native Debugger for advanced inspection
- Check Firebase Console for auth/Firestore issues
- Verify Supabase Storage bucket permissions if uploads fail

## Resources

- [Expo Router Docs](https://docs.expo.dev/router/introduction/)
- [NativeWind v4 Docs](https://www.nativewind.dev/v4/overview)
- [React Native Reusables](https://reactnativereusables.com)
- [Firebase React Native Guide](https://rnfirebase.io/) (not using @react-native-firebase)
